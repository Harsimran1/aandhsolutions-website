---
const {
  images = [],
  altBase = 'Case study image',
  autoplay = true,
  intervalMs = 5000,
  maxHeight,
} = Astro.props;

const sliderStyle = maxHeight ? `--cs-max-h: ${maxHeight};` : undefined;
---

<div class="cs-slider" data-slider data-autoplay={autoplay} data-interval={intervalMs} style={sliderStyle}>
  <div class="cs-slider__viewport">
    <div class="cs-slider__track">
      {images.map((src, index) => (
        <div class="cs-slide" data-slide-index={index}>
          <img src={src} alt={`${altBase} ${index + 1}`} />
        </div>
      ))}
    </div>
  </div>
  <button class="cs-nav cs-prev" type="button" aria-label="Previous slide">‹</button>
  <button class="cs-nav cs-next" type="button" aria-label="Next slide">›</button>
  <div class="cs-dots" role="tablist" aria-label="Slide navigation">
    {images.map((_, index) => (
      <button class="cs-dot" type="button" data-slide-index={index} aria-label={`Go to slide ${index + 1}`} aria-current={index === 0 ? 'true' : 'false'}></button>
    ))}
  </div>
</div>

<script>
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)');

  function initSlider(slider) {
    if (!slider) return;

    const track = slider.querySelector('.cs-slider__track');
    const prevBtn = slider.querySelector('.cs-prev');
    const nextBtn = slider.querySelector('.cs-next');
    const dotsContainer = slider.querySelector('.cs-dots');

    let slides = Array.from(slider.querySelectorAll('.cs-slide'));
    let dots = Array.from(slider.querySelectorAll('.cs-dot'));
    let index = 0;
    let timer = null;

    const autoplay = slider.dataset.autoplay === 'true';
    const interval = Number(slider.dataset.interval) || 5000;

    function updateUI() {
      slides.forEach((slide, i) => {
        slide.style.transform = `translateX(${(i - index) * 100}%)`;
      });

      dots.forEach((dot, i) => {
        if (i === index) {
          dot.setAttribute('aria-current', 'true');
        } else {
          dot.setAttribute('aria-current', 'false');
        }
      });

      const hasMultiple = slides.length > 1;
      prevBtn.style.display = hasMultiple ? 'flex' : 'none';
      nextBtn.style.display = hasMultiple ? 'flex' : 'none';
      dotsContainer.style.display = hasMultiple ? 'flex' : 'none';
    }

    function clampIndex() {
      if (index >= slides.length) index = slides.length - 1;
      if (index < 0) index = 0;
    }

    function goTo(nextIndex) {
      if (!slides.length) return;
      index = (nextIndex + slides.length) % slides.length;
      updateUI();
    }

    function startAutoplay() {
      if (!autoplay || prefersReduced.matches || slides.length <= 1) return;
      stopAutoplay();
      timer = window.setInterval(() => {
        goTo(index + 1);
      }, interval);
    }

    function stopAutoplay() {
      if (timer) {
        window.clearInterval(timer);
        timer = null;
      }
    }

    function rebuild() {
      slides = Array.from(slider.querySelectorAll('.cs-slide'));
      dots = Array.from(slider.querySelectorAll('.cs-dot'));
      clampIndex();
      updateUI();
      startAutoplay();
    }

    slides.forEach((slide) => {
      const img = slide.querySelector('img');
      if (!img) return;
      img.addEventListener('load', () => {
        img.classList.add('loaded');
      });
      img.addEventListener('error', () => {
        const slideIndex = slide.dataset.slideIndex;
        slide.remove();
        if (slideIndex !== undefined) {
          const dot = slider.querySelector(`.cs-dot[data-slide-index='${slideIndex}']`);
          if (dot) dot.remove();
        }
        rebuild();
      });
    });

    dots.forEach((dot, i) => {
      dot.addEventListener('click', () => {
        goTo(i);
      });
    });

    prevBtn.addEventListener('click', () => goTo(index - 1));
    nextBtn.addEventListener('click', () => goTo(index + 1));

    slider.addEventListener('mouseenter', stopAutoplay);
    slider.addEventListener('mouseleave', startAutoplay);
    slider.addEventListener('focusin', stopAutoplay);
    slider.addEventListener('focusout', startAutoplay);

    prefersReduced.addEventListener('change', () => {
      stopAutoplay();
      startAutoplay();
    });

    updateUI();
    startAutoplay();
  }

  document.querySelectorAll('[data-slider]').forEach(initSlider);
</script>

<style>
  .cs-slider {
    position: relative;
    border-radius: 0.75rem;
    overflow: hidden;
    background: #f8fafc;
  }

  .cs-slider__viewport {
    overflow: hidden;
    max-height: var(--cs-max-h, none);
    background: #ffffff;
  }

  .cs-slider__track {
    display: flex;
    width: 100%;
  }

  .cs-slide {
    min-width: 100%;
    transition: transform 0.45s ease;
  }

  .cs-slide img {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: contain;
    padding: 16px;
  }

  .cs-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    border-radius: 999px;
    border: none;
    background: rgba(15, 23, 42, 0.7);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    z-index: 2;
  }

  .cs-prev { left: 12px; }
  .cs-next { right: 12px; }

  .cs-dots {
    position: absolute;
    left: 50%;
    bottom: 12px;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
    z-index: 2;
  }

  .cs-dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    border: none;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
  }

  .cs-dot[aria-current='true'] {
    background: #fff;
  }

  @media (max-width: 640px) {
    .cs-nav {
      width: 34px;
      height: 34px;
      font-size: 20px;
    }
  }
</style>
