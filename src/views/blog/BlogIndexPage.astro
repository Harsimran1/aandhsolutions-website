---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import HeroSection from '../../components/HeroSection.astro';
import { getCollection } from 'astro:content';
import { resolveLocale, localizePath } from '../../lib/i18n';
import { getLocaleCopy } from '../../i18n/locale-copy';

const locale = resolveLocale(Astro.currentLocale, new URL(Astro.request.url).pathname);
const copy = getLocaleCopy(locale);
const blogCopy = copy.pages.blog ?? {};
const blogContent = copy.content?.blog ?? {};

const posts = await getCollection('blog', ({ data }) => !data.draft);
posts.sort((a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime());

const allTags = posts.flatMap((post) => post.data.tags || []);
const uniqueTags = [...new Set(allTags)].sort();

const DATE_LOCALE: Record<string, string> = {
  en: 'en-US',
  fr: 'fr-FR',
  de: 'de-DE',
  es: 'es-ES',
};

function getPostCopy(slug: string) {
  return blogContent[slug] ?? {};
}
---

<Layout
  title={blogCopy.title || 'Blog - A&H Solutions'}
  description={blogCopy.description || 'Latest insights, tutorials, and updates from A&H Solutions development team.'}
>
  <Header />
  <main>
    <HeroSection
      title={blogCopy.heroTitle || 'Latest Updates & News'}
      highlightText={blogCopy.heroHighlight || 'Updates'}
      description={blogCopy.heroDescription || 'Stay up to date with our latest product updates, feature releases, and company news.'}
    />

    <div class="container-custom py-8">
      <div class="text-center mb-8">
        <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">{blogCopy.browseByTopicTitle || 'Browse by Topic'}</h2>
        <p class="text-gray-600 dark:text-gray-300">{blogCopy.browseByTopicDescription || 'Filter articles by technology, tools, or topic'}</p>
      </div>
      <div class="flex flex-wrap gap-3 justify-center mb-12">
        <button class="px-4 py-2 rounded-full bg-primary-600 text-white font-medium text-sm hover:bg-primary-700 transition-colors tag-filter active" data-tag="all">
          {(blogCopy.allPostsLabel || 'All Posts')} ({posts.length})
        </button>
        {uniqueTags.map((tag) => {
          const tagCount = posts.filter((post) => post.data.tags?.includes(tag)).length;
          return (
            <button class="px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 font-medium text-sm hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors tag-filter" data-tag={tag}>
              {tag} ({tagCount})
            </button>
          );
        })}
      </div>

      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8" id="posts-grid">
        {posts.map((post, index) => {
          const postCopy = getPostCopy(post.slug);
          const postTitle = postCopy.title || post.data.title;
          const postDescription = postCopy.excerpt || postCopy.description || post.data.excerpt || post.data.description || '';

          return (
            <div class="card border border-gray-200 dark:border-gray-700 overflow-hidden slide-up blog-post" style={'animation-delay: ' + (index * 100) + 'ms'} data-tags={JSON.stringify(post.data.tags || [])}>
              <a href={localizePath(`/blog/${post.slug}`, locale)} class="block">
                {post.data.image && (
                  <img
                    src={post.data.image}
                    alt={post.data.imageAlt || postTitle}
                    class="w-full h-48 object-cover"
                    loading="lazy"
                  />
                )}
              </a>
              <div class="p-6">
                <div class="flex items-center mb-4 flex-wrap gap-2">
                  {post.data.tags && post.data.tags.length > 0 && (
                    <>
                      <div class="flex flex-wrap gap-2">
                        {post.data.tags.slice(0, 3).map((tag) => (
                          <span class="px-2 py-1 bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 text-xs rounded-full font-medium">{tag}</span>
                        ))}
                        {post.data.tags.length > 3 && (
                          <span class="px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 text-xs rounded-full">+{post.data.tags.length - 3} {blogCopy.moreLabel || 'more'}</span>
                        )}
                      </div>
                      <span class="mx-2 text-gray-300 dark:text-gray-600">â€¢</span>
                    </>
                  )}
                  <span class="text-sm text-gray-500 dark:text-gray-400">{post.data.publishedAt.toLocaleDateString(DATE_LOCALE[locale] || 'en-US')}</span>
                </div>
                <a href={localizePath(`/blog/${post.slug}`, locale)} class="block mb-3">
                  <h2 class="text-xl font-semibold text-gray-900 dark:text-white hover:text-primary-600 dark:hover:text-primary-400 transition-colors">{postTitle}</h2>
                </a>
                <p class="text-gray-600 dark:text-gray-300 mb-6">{postDescription}</p>
                <div class="flex items-center">
                  {post.data.author.avatar && (
                    <img
                      src={post.data.author.avatar}
                      alt={post.data.author.name}
                      class="w-10 h-10 rounded-full mr-3 object-cover"
                      loading="lazy"
                    />
                  )}
                  <div>
                    <p class="font-medium text-gray-900 dark:text-white">{post.data.author.name}</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">{post.data.author.email}</p>
                  </div>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      <div class="mt-12 flex justify-center">
        <a href="#" class="btn-outline">
          {blogCopy.loadMoreLabel || 'Load More Articles'}
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v10.586l3.293-3.293a1 1 0 011.414 1.414l-5 5a1 1 0 01-1.414 0l-5-5a1 1 0 111.414-1.414L9 14.586V4a1 1 0 011-1z" clip-rule="evenodd" />
          </svg>
        </a>
      </div>
    </div>
  </main>
  <Footer />

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const tagFilters = document.querySelectorAll('.tag-filter');
      const blogPosts = document.querySelectorAll('.blog-post');

      tagFilters.forEach(filter => {
        filter.addEventListener('click', function() {
          const selectedTag = this.getAttribute('data-tag');

          tagFilters.forEach(f => {
            f.classList.remove('active', 'bg-primary-600', 'text-white');
            f.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
          });

          this.classList.add('active', 'bg-primary-600', 'text-white');
          this.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');

          blogPosts.forEach(post => {
            const postTags = JSON.parse(post.getAttribute('data-tags'));

            if (selectedTag === 'all' || postTags.includes(selectedTag)) {
              post.style.display = 'block';
              post.classList.add('slide-up');
            } else {
              post.style.display = 'none';
              post.classList.remove('slide-up');
            }
          });

          let visibleIndex = 0;
          blogPosts.forEach(post => {
            if (post.style.display !== 'none') {
              post.style.animationDelay = `${visibleIndex * 100}ms`;
              visibleIndex++;
            }
          });
        });
      });
    });
  </script>
</Layout>
