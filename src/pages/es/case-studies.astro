---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import HeroSection from '../../components/HeroSection.astro';
import CaseStudySlider from '../../components/CaseStudySlider.astro';
import { getCollection } from 'astro:content';
import { resolveLocale, localizePath } from '../../lib/i18n';
import { getLocaleCopy } from '../../i18n/locale-copy';

function getYouTubeEmbed(url: string | undefined, autoplay: boolean = false) {
  if (!url) return null;
  try {
    const parsed = new URL(url);
    const autoplayParam = autoplay ? 'autoplay=1&mute=1&' : '';
    if (parsed.hostname.includes('youtu.be')) {
      const id = parsed.pathname.slice(1);
      if (!id) return null;
      return `https://www.youtube.com/embed/${id}?${autoplayParam}controls=1&rel=0&playsinline=1`;
    }
    if (parsed.hostname.includes('youtube.com')) {
      if (parsed.pathname.startsWith('/embed/')) {
        return `${parsed.origin}${parsed.pathname}?${autoplayParam}controls=1&rel=0&playsinline=1`;
      }
      const id = parsed.searchParams.get('v');
      if (!id) return null;
      return `https://www.youtube.com/embed/${id}?${autoplayParam}controls=1&rel=0&playsinline=1`;
    }
  } catch (_) {
    return null;
  }
  return null;
}

const locale = resolveLocale(Astro.currentLocale, Astro.url.pathname);
const copy = getLocaleCopy(locale);
const casePageCopy = copy.pages.caseStudies ?? {};
const caseContent = copy.content?.caseStudies ?? {};

const caseStudies = await getCollection('case-studies', ({ data }) => !data.draft);

const featuredOrder = [
  'propcan-real-estate-platform',
  'sigxa-medical-scribe',
  'coursera-degree-progress',
  'mycloudsync-patient-flow',
  'juree-legal-translations',
  'smartvet-medical-translation',
  'data4life-patient-platform',
  'aquanomix-water-monitoring',
  'greenswapp-apis',
  'levven-smart-home',
  'cannabis-ecommerce-platform',
  'babajob-job-marketplace',
];

const orderIndex = new Map(featuredOrder.map((slug, index) => [slug, index]));

caseStudies.sort((a, b) => {
  const aIdx = orderIndex.has(a.slug) ? orderIndex.get(a.slug) : Infinity;
  const bIdx = orderIndex.has(b.slug) ? orderIndex.get(b.slug) : Infinity;
  if (aIdx !== bIdx) return aIdx - bIdx;
  return new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime();
});

function getCaseCopy(slug: string) {
  return caseContent[slug] ?? {};
}
---

<Layout title={casePageCopy.title || 'Case Studies - A&H Solutions'}>
  <Header />
  <main>
    <HeroSection
      title={casePageCopy.heroTitle || 'Case Studies'}
      highlightText={casePageCopy.heroHighlight || 'Studies'}
      description={casePageCopy.heroDescription || 'See how our clients are achieving success with A&H Solutions.'}
    />

    <section class="py-16 bg-white dark:bg-gray-800">
      <div class="container-custom">
        {caseStudies.length > 0 ? (
          caseStudies.map((caseStudy, index) => {
            const caseCopy = getCaseCopy(caseStudy.slug);
            const caseTitle = caseCopy.title || caseStudy.data.title;
            const caseDescription = caseCopy.excerpt || caseCopy.description || caseStudy.data.excerpt || caseStudy.data.description;

            return (
              <div class="mb-24">
                <div class="grid md:grid-cols-2 gap-12 items-center mb-12">
                  <div class={index % 2 === 1 ? 'order-2 md:order-1' : ''}>
                    {caseStudy.data.client && (
                      <span class="inline-block px-4 py-1 rounded-full bg-secondary-100 dark:bg-secondary-900 text-secondary-600 dark:text-secondary-300 font-medium text-sm mb-4">
                        {caseStudy.data.client.industry}
                      </span>
                    )}
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">{caseTitle}</h2>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">{caseDescription}</p>
                    {caseStudy.data.results && caseStudy.data.results.metrics && (
                      <div class="flex flex-wrap gap-4 mb-6">
                        {caseStudy.data.results.metrics.map((metric) => (
                          <div class="flex items-center">
                            <svg class="w-5 h-5 text-primary-600 dark:text-primary-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span class="text-gray-700 dark:text-gray-300">{metric.label}: {metric.value}</span>
                          </div>
                        ))}
                      </div>
                    )}
                    <a href={localizePath(`/case-studies/${caseStudy.slug}`, locale)} class="btn-primary">{casePageCopy.readFullCaseStudy || 'Read Full Case Study'}</a>
                  </div>
                  <div class={`rounded-lg overflow-hidden shadow-xl ${index % 2 === 1 ? 'order-1 md:order-2' : ''}`}>
                    {caseStudy.data.videoUrl ? (
                      <div class="relative w-full aspect-video bg-black">
                        <iframe
                          class="absolute inset-0 w-full h-full"
                          src={getYouTubeEmbed(caseStudy.data.videoUrl, index === 0)}
                          title={`${caseTitle} video`}
                          frameborder="0"
                          allow="autoplay; encrypted-media; picture-in-picture"
                          allowfullscreen
                        ></iframe>
                      </div>
                    ) : caseStudy.data.image ? (
                      <CaseStudySlider
                        images={caseStudy.data.gallery && caseStudy.data.gallery.length > 0 ? caseStudy.data.gallery : [caseStudy.data.image]}
                        altBase={caseStudy.data.imageAlt || caseTitle}
                      />
                    ) : (
                      <div class="w-full h-64 bg-gradient-to-br from-primary-500 to-secondary-500 flex items-center justify-center">
                        <span class="text-white text-xl font-semibold">{caseStudy.data.client?.name || (casePageCopy.defaultCardLabel || 'Case Study')}</span>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          })
        ) : (
          <div class="text-center py-16">
            <h3 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">{casePageCopy.comingSoonTitle || 'Case Studies Coming Soon'}</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-8 max-w-2xl mx-auto">
              {casePageCopy.comingSoonDescription || "We're currently working on documenting our successful client projects. Check back soon to see how we've helped businesses achieve their goals."}
            </p>
            <a href={localizePath('/contact', locale)} class="btn-primary">{casePageCopy.discussProject || 'Discuss Your Project'}</a>
          </div>
        )}

        <div class="mt-16 mb-12">
          <div class="bg-gradient-to-r from-primary-50 to-accent-50 dark:from-primary-950/50 dark:to-accent-950/50 border border-primary-200 dark:border-primary-800 rounded-xl p-8 text-center max-w-4xl mx-auto">
            <div class="mb-6">
              <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-3">{casePageCopy.blueprintTitle || 'Start With Your FREE Project Blueprint'}</h3>
              <p class="text-gray-600 dark:text-gray-300 text-lg mb-4">
                {casePageCopy.blueprintDescription || 'Before diving into development, get a comprehensive project roadmap that sets you up for success like our case study clients.'}
              </p>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">
                {casePageCopy.blueprintMeta || 'Technical architecture • Wireframes • Risk analysis • Implementation plan • 100% Free'}
              </p>
            </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4 mb-4">
              <a href={localizePath('/free-project-blueprint', locale)} class="btn-primary">{casePageCopy.getBlueprint || 'Get My Free Blueprint'}</a>
              <a href={localizePath('/contact', locale)} class="btn-outline">{casePageCopy.discussProject || 'Discuss Your Project'}</a>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400">{casePageCopy.blueprintFootnote || 'Delivered in 3-5 business days • No obligation'}</p>
          </div>
        </div>

        <div class="text-center">
          <h3 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">{casePageCopy.readyTitle || 'Ready to achieve similar results?'}</h3>
          <p class="text-gray-600 dark:text-gray-300 mb-8 max-w-2xl mx-auto">
            {casePageCopy.readyDescription || 'Let A&H Solutions help transform your business with our proven expertise. Our team is ready to help you succeed.'}
          </p>
          <div class="flex flex-col sm:flex-row justify-center gap-4">
            <a href={localizePath('/contact', locale)} class="btn-primary">{casePageCopy.discussProject || 'Discuss Your Project'}</a>
            <a href={localizePath('/company', locale)} class="btn-secondary">{casePageCopy.learnAboutUs || 'Learn About Us'}</a>
          </div>
        </div>
      </div>
    </section>
  </main>
  <Footer />
</Layout>
