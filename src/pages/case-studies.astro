---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import HeroSection from '../components/HeroSection.astro';
import CaseStudySlider from '../components/CaseStudySlider.astro';
import { getCollection } from 'astro:content';

function getYouTubeEmbed(url: string | undefined) {
  if (!url) return null;
  try {
    const parsed = new URL(url);
    if (parsed.hostname.includes('youtu.be')) {
      const id = parsed.pathname.slice(1);
      if (!id) return null;
      return `https://www.youtube.com/embed/${id}?autoplay=1&mute=1&controls=1&rel=0&playsinline=1`;
    }
    if (parsed.hostname.includes('youtube.com')) {
      if (parsed.pathname.startsWith('/embed/')) {
        return `${parsed.origin}${parsed.pathname}?autoplay=1&mute=1&controls=1&rel=0&playsinline=1`;
      }
      const id = parsed.searchParams.get('v');
      if (!id) return null;
      return `https://www.youtube.com/embed/${id}?autoplay=1&mute=1&controls=1&rel=0&playsinline=1`;
    }
  } catch (_) {
    return null;
  }
  return null;
}

const caseStudies = await getCollection('case-studies', ({ data }) => {
  return !data.draft;
});

const featuredOrder = [
  'propcan-real-estate-platform',
  'sigxa-medical-scribe',
  'coursera-degree-progress',
  'mycloudsync-patient-flow',
  'juree-legal-translations',
  'smartvet-medical-translation',
  'data4life-patient-platform',
  'aquanomix-water-monitoring',
  'greenswapp-apis',
  'levven-smart-home',
  'cannabis-ecommerce-platform',
  'babajob-job-marketplace',
];

const orderIndex = new Map(featuredOrder.map((slug, index) => [slug, index]));

caseStudies.sort((a, b) => {
  const aIdx = orderIndex.has(a.slug) ? orderIndex.get(a.slug) : Infinity;
  const bIdx = orderIndex.has(b.slug) ? orderIndex.get(b.slug) : Infinity;
  if (aIdx !== bIdx) return aIdx - bIdx;
  return new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime();
});
---

<Layout title="Case Studies - A&H Solutions">
  <Header />
  <main>
    <HeroSection 
      title="Case Studies" 
      highlightText="Studies"
      description="See how our clients are achieving success with A&H Solutions."
    />
    
    <section class="py-16 bg-white dark:bg-gray-800">
      <div class="container-custom">
        {caseStudies.length > 0 ? (
          caseStudies.map((caseStudy, index) => (
            <div class="mb-24">
              <div class="grid md:grid-cols-2 gap-12 items-center mb-12">
                <div class={index % 2 === 1 ? 'order-2 md:order-1' : ''}>
                  {caseStudy.data.client && (
                    <span class="inline-block px-4 py-1 rounded-full bg-secondary-100 dark:bg-secondary-900 text-secondary-600 dark:text-secondary-300 font-medium text-sm mb-4">
                      {caseStudy.data.client.industry}
                    </span>
                  )}
                  <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">{caseStudy.data.title}</h2>
                  <p class="text-gray-600 dark:text-gray-300 mb-6">
                    {caseStudy.data.excerpt || caseStudy.data.description}
                  </p>
                  {caseStudy.data.results && caseStudy.data.results.metrics && (
                    <div class="flex flex-wrap gap-4 mb-6">
                      {caseStudy.data.results.metrics.map((metric) => (
                        <div class="flex items-center">
                          <svg class="w-5 h-5 text-primary-600 dark:text-primary-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                          </svg>
                          <span class="text-gray-700 dark:text-gray-300">{metric.label}: {metric.value}</span>
                        </div>
                      ))}
                    </div>
                  )}
                  <a href={`/case-studies/${caseStudy.slug}`} class="btn-primary">Read Full Case Study</a>
                </div>
                <div class={`rounded-lg overflow-hidden shadow-xl ${index % 2 === 1 ? 'order-1 md:order-2' : ''}`}>
                  {caseStudy.data.videoUrl ? (
                    <div class="relative w-full aspect-video bg-black">
                      <iframe
                        class="absolute inset-0 w-full h-full"
                        src={getYouTubeEmbed(caseStudy.data.videoUrl)}
                        title={`${caseStudy.data.title} video`}
                        frameborder="0"
                        allow="autoplay; encrypted-media; picture-in-picture"
                        allowfullscreen
                      ></iframe>
                    </div>
                  ) : caseStudy.data.image ? (
                    <CaseStudySlider
                      images={caseStudy.data.gallery && caseStudy.data.gallery.length > 0 ? caseStudy.data.gallery : [caseStudy.data.image]}
                      altBase={caseStudy.data.imageAlt || caseStudy.data.title}
                    />
                  ) : (
                    <div class="w-full h-64 bg-gradient-to-br from-primary-500 to-secondary-500 flex items-center justify-center">
                      <span class="text-white text-xl font-semibold">{caseStudy.data.client?.name || 'Case Study'}</span>
                    </div>
                  )}
                </div>
              </div>
            </div>
          ))
        ) : (
          <div class="text-center py-16">
            <h3 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">Case Studies Coming Soon</h3>
            <p class="text-gray-600 dark:text-gray-300 mb-8 max-w-2xl mx-auto">
              We're currently working on documenting our successful client projects. Check back soon to see how we've helped businesses achieve their goals.
            </p>
            <a href="/contact" class="btn-primary">Discuss Your Project</a>
          </div>
        )}
        
        <!-- FREE Project Blueprint CTA -->
        <div class="mt-16 mb-12">
          <div class="bg-gradient-to-r from-primary-50 to-accent-50 dark:from-primary-950/50 dark:to-accent-950/50 border border-primary-200 dark:border-primary-800 rounded-xl p-8 text-center max-w-4xl mx-auto">
            <div class="mb-6">
              <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-3">
                üéÅ Start With Your FREE Project Blueprint
              </h3>
              <p class="text-gray-600 dark:text-gray-300 text-lg mb-4">
                Before diving into development, get a comprehensive project roadmap that sets you up for success like our case study clients.
              </p>
              <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">
                Technical architecture ‚Ä¢ Wireframes ‚Ä¢ Risk analysis ‚Ä¢ Implementation plan ‚Ä¢ 100% Free
              </p>
            </div>
            <div class="flex flex-col sm:flex-row justify-center gap-4 mb-4">
              <a href="/free-project-blueprint" class="btn-primary">Get My Free Blueprint</a>
              <a href="/contact" class="btn-outline">Discuss Your Project</a>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400">Delivered in 3-5 business days ‚Ä¢ No obligation</p>
          </div>
        </div>
        
        <div class="text-center">
          <h3 class="text-2xl font-semibold text-gray-900 dark:text-white mb-4">Ready to achieve similar results?</h3>
          <p class="text-gray-600 dark:text-gray-300 mb-8 max-w-2xl mx-auto">
            Let A&H Solutions help transform your business with our proven expertise. Our team is ready to help you succeed.
          </p>
          <div class="flex flex-col sm:flex-row justify-center gap-4">
            <a href="/contact" class="btn-primary">Discuss Your Project</a>
            <a href="/company" class="btn-secondary">Learn About Us</a>
          </div>
        </div>
      </div>
    </section>
  </main>
  <Footer />
</Layout> 
